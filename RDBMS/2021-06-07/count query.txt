SELECT
	A.DGNSS_IDX
	, A.MTR_MODEL_IDX
	, A.MTR_SERIAL_NO
	, (SELECT CD_NM FROM tb_code_c WHERE CD_IDX = DGNSS_CRSE_CD) as DGNSS_CRSE_CD
	, (SELECT CD_NM FROM tb_code_c WHERE CD_IDX = MDL_STTS_CD) as MDL_STTS_CD
	, A.MTR_ERCRT_FILE_IDX
	, A.MTR_VLTG_FILE_IDX
	, A.RGT_DTTM
	, B.DGNSS_KIND_CD
FROM
	tb_diagnosis_m A
	inner join tb_diagnosis_result_d B on A.DGNSS_IDX = B.DGNSS_IDX
WHERE
	A.DLT_DTTM IS null
	and
	(
		(B.DGNSS_KIND_CD = 12 and B.DGNSS_FLAW_CD = 17 and B.DGNSS_RSLT_VAL >= 0.5)
	and (B.DGNSS_KIND_CD = 15 and B.DGNSS_FLAW_CD = 18 and B.DGNSS_RSLT_VAL < 0.5)
	);
	
	
SELECT
	d.DGNSS_IDX,
	d.MTR_MODEL_IDX,
	d.MTR_SERIAL_NO,
	(SELECT CD_NM FROM tb_code_c WHERE CD_IDX = d.DGNSS_CRSE_CD) as DGNSS_CRSE_CD,
	(SELECT CD_NM FROM tb_code_c WHERE CD_IDX = d.MDL_STTS_CD) as MDL_STTS_CD
FROM
	tb_diagnosis_m AS d
	INNER JOIN 
		(
			SELECT * FROM tb_diagnosis_result_d
			WHERE 
				DGNSS_KIND_CD=11 AND DGNSS_FLAW_CD=18 AND DGNSS_RSLT_VAL>0.5 AND DGNSS_RSLT_VAL<0.7
			ORDER BY DGNSS_RSLT_IDX ASC
		) AS dr ON d.DGNSS_IDX = dr.DGNSS_IDX
GROUP BY
	d.DGNSS_IDX
order by
	d.dgnss_idx;


SELECT * FROM (
	SELECT
		d.DGNSS_IDX,
		d.MTR_MODEL_IDX,
		d.MTR_SERIAL_NO,
		(SELECT CD_NM FROM tb_code_c WHERE CD_IDX = d.DGNSS_CRSE_CD) as DGNSS_CRSE_CD,
		(SELECT CD_NM FROM tb_code_c WHERE CD_IDX = d.MDL_STTS_CD) as MDL_STTS_CD
		, dr.DGNSS_RSLT_IDX
		, dr.DGNSS_KIND_CD
		, dr.DGNSS_FLAW_CD
		, dr.DGNSS_RSLT_VAL
		, COUNT(dr.DGNSS_IDX) AS CNT
	FROM
		tb_diagnosis_m AS d
		INNER JOIN 
			(
				SELECT * FROM tb_diagnosis_result_d 
				WHERE 
					(DGNSS_KIND_CD=11 AND DGNSS_FLAW_CD=17 AND DGNSS_RSLT_VAL>0 AND DGNSS_RSLT_VAL<0.5) 
						OR (DGNSS_KIND_CD=11 AND DGNSS_FLAW_CD=18 AND DGNSS_RSLT_VAL>0 AND DGNSS_RSLT_VAL<0.8) 
						OR (DGNSS_KIND_CD=11 AND DGNSS_FLAW_CD=19 AND DGNSS_RSLT_VAL>0 AND DGNSS_RSLT_VAL<0.5) 
						OR (DGNSS_KIND_CD=12 AND DGNSS_FLAW_CD=17 AND DGNSS_RSLT_VAL=0) 
						OR (DGNSS_KIND_CD=12 AND DGNSS_FLAW_CD=18 AND DGNSS_RSLT_VAL=1) 
						OR (DGNSS_KIND_CD=12 AND DGNSS_FLAW_CD=19 AND DGNSS_RSLT_VAL=0)
						OR (DGNSS_KIND_CD=14 AND DGNSS_FLAW_CD=17 AND DGNSS_RSLT_VAL=0) 
						OR (DGNSS_KIND_CD=14 AND DGNSS_FLAW_CD=18 AND DGNSS_RSLT_VAL=1) 
						OR (DGNSS_KIND_CD=14 AND DGNSS_FLAW_CD=19 AND DGNSS_RSLT_VAL=0)
						OR (DGNSS_KIND_CD=15 AND DGNSS_FLAW_CD=17 AND DGNSS_RSLT_VAL=0) 
						OR (DGNSS_KIND_CD=15 AND DGNSS_FLAW_CD=18 AND DGNSS_RSLT_VAL=1) 
						OR (DGNSS_KIND_CD=15 AND DGNSS_FLAW_CD=19 AND DGNSS_RSLT_VAL=0)
				ORDER BY DGNSS_RSLT_IDX ASC
			) AS dr ON d.DGNSS_IDX = dr.DGNSS_IDX
	where
		d.DLT_DTTM is NULL
	GROUP BY
		d.DGNSS_IDX
	) AS RES
WHERE
	RES.CNT=12;
	

SELECT * FROM (
	SELECT
		d.DGNSS_IDX,
		d.MTR_MODEL_IDX,
		d.MTR_SERIAL_NO,
		(SELECT CD_NM FROM tb_code_c WHERE CD_IDX = d.DGNSS_CRSE_CD) as DGNSS_CRSE_CD,
		(SELECT CD_NM FROM tb_code_c WHERE CD_IDX = d.MDL_STTS_CD) as MDL_STTS_CD
		, dr.DGNSS_RSLT_IDX
		, dr.DGNSS_KIND_CD
		, dr.DGNSS_FLAW_CD
		, dr.DGNSS_RSLT_VAL
		, COUNT(dr.DGNSS_IDX) AS CNT
	FROM
		tb_diagnosis_m AS d
		INNER JOIN 
			(
				SELECT * FROM tb_diagnosis_result_d 
				WHERE 
						(DGNSS_KIND_CD=12 AND DGNSS_FLAW_CD=17 AND DGNSS_RSLT_VAL=0) 
				ORDER BY DGNSS_RSLT_IDX ASC
			) AS dr ON d.DGNSS_IDX = dr.DGNSS_IDX
	where
		d.DLT_DTTM is null
	and d.MTR_MODEL_IDX = 25
	GROUP BY
		d.DGNSS_IDX
		) AS RES
WHERE
	RES.CNT=1
	


SELECT
	COUNT(DGNSS_IDX)
FROM
	tb_diagnosis_m
WHERE
	DLT_DTTM IS NULL
	AND MTR_MODEL_IDX = 25
	AND MTR_SERIAL_NO LIKE CONCAT('%', 1 ,'%')
	
	
	
SELECT count(DGNSS_IDX) FROM (
	SELECT
		d.DGNSS_IDX
		, COUNT(dr.DGNSS_IDX) AS CNT
	FROM
		tb_diagnosis_m AS d
		INNER JOIN 
			(
				SELECT * FROM tb_diagnosis_result_d 
				WHERE 
						(DGNSS_KIND_CD=15 AND DGNSS_FLAW_CD=17 AND DGNSS_RSLT_VAL=0) 
						OR (DGNSS_KIND_CD=15 AND DGNSS_FLAW_CD=18 AND DGNSS_RSLT_VAL=1) 
				ORDER BY DGNSS_RSLT_IDX ASC
			) AS dr ON d.DGNSS_IDX = dr.DGNSS_IDX
	where
		d.DLT_DTTM is NULL
	GROUP BY
		d.DGNSS_IDX
	) AS RES
WHERE
	RES.CNT=2;